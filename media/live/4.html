<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>SEVENTEEN ZONE PH - Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
 :root { 
        --bg: #050505; --text: #ffffff; --header-bg: #0a0a0a; 
        --border: rgba(255,255,255,0.1); --accent: #8b5cf6; 
        --pill-bg: #151515; --card-bg: #1a1a1a;
        --control-bg: linear-gradient(to top, rgba(0,0,0,0.9) 20%, transparent);
        --success: #22c55e; --error: #ef4444;
    }
    body.light-mode {
        --bg: #e5e7eb; --text: #1f2937; --header-bg: #ffffff; 
        --border: rgba(0,0,0,0.05); --pill-bg: #f3f4f6; --card-bg: #ffffff;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; -webkit-user-select: none; user-select: none; }
    body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; transition: background 0.3s; }

    /* --- PERMANENT HEADER --- */
    .header-container { position: fixed; top: 20px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 9999; padding: 0 4%; pointer-events: none; }
    .header { pointer-events: auto; width: 100%; max-width: 1280px; background: var(--header-bg); border: 1px solid var(--border); border-radius: 30px; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); min-height: 60px; }
    .brand-section { display: flex; align-items: center; gap: 12px; }
    .logo { font-weight: 800; font-size: 16px; display: flex; align-items: center; gap: 8px; color: var(--text); letter-spacing: 0.5px; text-transform: uppercase; }
    .logo-img { height: 28px; width: auto; filter: drop-shadow(0 0 5px rgba(139, 92, 246, 0.3)); }
    .nav-right { display: flex; align-items: center; gap: 5px; }
    .icon-btn { background: transparent; border: none; color: var(--text); font-size: 18px; cursor: pointer; padding: 10px; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }
    .back-btn { color: var(--text); font-size: 18px; text-decoration: none; margin-right: 10px; display: flex; align-items: center; }

    /* --- CINEMATIC CONTAINER --- */
    .main-container { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); width: 100%; max-width: 1280px; padding: 30px 4% 0 4%; display: flex; flex-direction: column; align-items: center; height: calc(100vh - 100px); overflow-y: auto; scrollbar-width: none; }
    .main-container::-webkit-scrollbar { display: none; }

    /* --- PLAYER --- */
    .player-wrapper { 
        width: 100%; max-width: 1000px; 
        background: #000; 
        border-radius: 24px; 
        overflow: hidden; 
        position: relative; 
        aspect-ratio: 16/9; 
        margin-bottom: 40px; 
        box-shadow: none !important;
        border: none !important;
    }
    video { width: 100%; height: 100%; object-fit: contain; display: block; }

    /* --- INFO --- */
    .video-info { width: 100%; max-width: 1000px; padding: 0 10px 60px 10px; text-align: left; }
    .video-title { margin: 0 0 20px 0; font-size: 24px; font-weight: 800; line-height: 1.2; color: var(--text); text-transform: uppercase; }
    .video-meta { font-size: 13px; color: #888; display: flex; align-items: center; gap: 10px; font-weight: 600; flex-wrap: wrap;}
    
    .stat-item { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        background: var(--pill-bg); 
        padding: 8px 16px; 
        border-radius: 14px; 
        border: 1px solid var(--border);
        transition: transform 0.2s;
    }
    #liveCount, #shareCount, #currentTime { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; transition: color 0.3s; font-weight: 700; color: var(--text); }

    /* --- CONTROLS --- */
    .controls-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; opacity: 0; transition: opacity 0.4s ease, visibility 0.4s; pointer-events: none; z-index: 10; }
    .player-wrapper.show-controls .controls-overlay { opacity: 1; pointer-events: auto; }
    .bottom-bar { background: var(--control-bg); padding: 20px 25px calc(20px + env(safe-area-inset-bottom)) 25px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .ctrl-group { display: flex; align-items: center; gap: 15px; }
    .ctrl-btn { background: transparent; border: none; color: white; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 50%; transition: 0.2s; }
    .volume-container { display: flex; align-items: center; gap: 8px; }
    input[type=range] { -webkit-appearance: none; width: 80px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; }
    .live-badge { color: white; font-weight: 800; font-size: 13px; letter-spacing: 1.5px; margin-right: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .center-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); font-size: 70px; color: rgba(255,255,255,0.9); opacity: 0; pointer-events: none; transition: all 0.2s; z-index: 11; }
    .center-icon.animate { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    .center-icon.fade-out { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }

    /* EXPIRED SCREEN (Hidden by default now) */
    #expiredScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 20000; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; }
    .expired-icon { font-size: 50px; color: var(--error); margin-bottom: 20px; }

    /* MODAL */
    .share-modal { 
        position: fixed; top: 50%; left: 50%; 
        transform: translate(-50%, -50%) scale(0.9); 
        background: var(--header-bg); 
        border: 1px solid var(--border); 
        padding: 25px 30px; 
        border-radius: 25px; 
        display: flex; flex-direction: column; align-items: center; gap: 10px; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
        z-index: 999999; 
        opacity: 0; pointer-events: none; 
        transition: all 0.3s ease; 
        backdrop-filter: blur(20px); 
        visibility: hidden; 
        text-align: center; width: 280px; 
    }
    .share-modal.active { opacity: 1; transform: translate(-50%, -50%) scale(1); visibility: visible; pointer-events: auto; }
    .modal-icon { width: 45px; height: 45px; background: rgba(34, 197, 94, 0.15); color: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }

    @media (max-width: 600px) {
        .header { padding: 8px 15px; border-radius: 20px; min-height: 50px; }
        .logo { font-size: 13px; } .logo-img { height: 22px; }
        .main-container { top: 85px; padding-top: 20px; }
        .player-wrapper { border-radius: 16px; margin-bottom: 25px; }
        .video-title { font-size: 18px; }
        .bottom-bar { padding: 10px 15px 15px 15px; }
        .ctrl-btn { font-size: 18px; width: 38px; height: 38px; }
        input[type=range] { width: 60px; }
        .ctrl-group { gap: 8px; } .live-badge { font-size: 11px; margin-right: 5px; }
        .video-meta { gap: 8px; }
        .stat-item { padding: 6px 10px; font-size: 11px; }
    }
  </style>
</head>
<body>

<div id="expiredScreen">
    <div class="expired-icon"><i class="fas fa-ban"></i></div>
    <h1 style="margin:0 0 10px 0;">Link Expired</h1>
    <p style="color:#888;">This secure link is no longer valid.</p>
    <a href="https://mem-collection.vercel.app" style="color:var(--accent); margin-top:20px; text-decoration:none; border:1px solid var(--accent); padding:10px 20px; border-radius:20px;">Return Home</a>
</div>

<div class="header-container" id="mainHeader">
    <div class="header">
        <div class="brand-section">
            <a href="https://mem-collection.vercel.app" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <div class="logo">
                <img src="https://res.cloudinary.com/dp6x9xmku/image/upload/v1771253635/1-removebg-preview_zteop7.png" alt="SVT Logo" class="logo-img">
                SEVENTEEN ZONE PH
            </div>
        </div>
        <div class="nav-right">
            <button class="icon-btn" onclick="toggleTheme()" ontouchstart=""><i class="fas fa-moon" id="themeIcon"></i></button>
            <button class="icon-btn" onclick="handleShare()" ontouchstart=""><i class="fas fa-share-nodes"></i></button>
        </div>
    </div>
</div>

<div class="main-container">
    <div class="player-wrapper" id="videoContainer">
        <video id="videoPlayer" playsinline crossorigin="anonymous" autoplay muted poster="https://res.cloudinary.com/dp6x9xmku/image/upload/v1771258219/hxw_bpcyzo.png"></video>
        <div class="center-icon" id="centerIcon"><i class="fas fa-play"></i></div>
        <div class="controls-overlay" id="controlsOverlay">
            <div class="bottom-bar">
                <div class="ctrl-group">
                    <button class="ctrl-btn" id="playBtn"><i class="fas fa-pause"></i></button>
                    <div class="volume-container">
                        <button class="ctrl-btn" id="muteBtn" style="width: 30px;"><i class="fas fa-volume-mute"></i></button>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0">
                    </div>
                </div>
                <div class="ctrl-group">
                    <div class="live-badge">LIVE</div>
                    <button class="ctrl-btn" id="fsBtn"><i class="fas fa-expand"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="video-info">
        <h1 class="video-title" id="videoTitle">SEVENTEEN 2025 JAPAN FANMEETING 'HOLIDAY'</h1>
        <div class="video-meta">
            <span class="stat-item"><i class="far fa-eye"></i> <span id="liveCount">...</span> Watching</span>
            <span class="stat-item"><i class="fas fa-share"></i> <span id="shareCount">0</span> Shares</span>
            <span class="stat-item"><i class="far fa-calendar"></i> Feb 21, 2026</span>
            <span class="stat-item"><i class="far fa-clock"></i> <span id="currentTime">--:--:--</span></span>
        </div>
    </div>
</div>

<div id="shareModal" class="share-modal">
    <div class="modal-icon"><i class="fas fa-check"></i></div>
    <h3 style="color:var(--text); margin:0; font-size:16px;">Link Copied!</h3>
    <p style="color:#888; font-size:12px; margin:0;">Share this link with your friends!</p>
</div>

<script>
    // --- SETUP ---
    const SUPABASE_URL = 'https://qycukzzueysguuygzdcx.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_0O9VOP25-PsAYknWeS3A7Q_ocat-IZz';
    let supabaseClient = null;
    let channel = null;

// --- START ---
    window.addEventListener('load', () => {
        // 1. Generate RANDOM NUMBER url on load (no expiry)
        const params = new URLSearchParams(window.location.search);
        // If there is no 'rmd' parameter, add one
        if (!params.get('rmd')) {
            const randomNum = Math.floor(Math.random() * 900000000) + 100000000; // Generate random ID
            const title = document.getElementById('videoTitle').innerText;
            const newUrl = `${window.location.pathname}?title=${encodeURIComponent(title)}&token=svtzoneph&rmd=${randomNum}`;
            
            // Updates address bar immediately
            window.history.replaceState(null, '', newUrl);
        }

        // 2. Check Expiry (Only if 'exp' param exists from old links)
        if (!checkExpiry()) return;

        if (localStorage.getItem('zoneTheme') === 'light') {
            document.body.classList.add('light-mode');
            document.getElementById('themeIcon').className = 'fas fa-sun';
        }

        initPlayer();
        initSupabase();
        startClock(); 
    });

    // --- LIVE CLOCK LOGIC ---
    function startClock() {
        function update() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('currentTime').innerText = timeStr;
        }
        setInterval(update, 1000);
        update();
    }

    // --- EXPIRY CHECK ---
    function checkExpiry() {
        const params = new URLSearchParams(window.location.search);
        const expiresAt = params.get('exp');
        
        // If the URL has 'exp', check it. If it has 'rmd', ignore expiry.
        if (expiresAt) {
            const now = Date.now();
            if (now > parseInt(expiresAt)) {
                document.getElementById('expiredScreen').style.display = 'flex';
                document.getElementById('mainHeader').style.display = 'none';
                document.querySelector('.main-container').style.display = 'none';
                return false;
            }
        }
        return true;
    }

// --- SHARE LOGIC ---
    async function handleShare() {
        // Generate a NEW random number for the shared link
        const randomNum = Math.floor(Math.random() * 900000000) + 100000000;
        const baseUrl = window.location.origin + window.location.pathname;
        const title = document.getElementById('videoTitle').innerText;
        
        // Use 'rmd' instead of 'exp'
        const queryParams = `?title=${encodeURIComponent(title)}&token=svtzoneph&rmd=${randomNum}`;
        const shareUrl = baseUrl + queryParams;
        
        try {
            await navigator.clipboard.writeText(shareUrl);
        } catch (e) {
            console.log("Clipboard error", e);
        }
        
        const modal = document.getElementById('shareModal');
        modal.classList.add('active');
        setTimeout(() => { modal.classList.remove('active'); }, 3000);

        const el = document.getElementById('shareCount');
        let current = parseInt(el.innerText.replace(/,/g, '')) || 0;
        updateShareUI(current + 1);

        if (supabaseClient) {
            const { error } = await supabaseClient.rpc('increment_share');
            if (error) console.error("DB Error", error);
        }
    }

    function updateShareUI(count) {
        const el = document.getElementById('shareCount');
        if (el.innerText !== count.toString()) {
            el.innerText = count.toLocaleString();
            el.style.color = '#8b5cf6';
            setTimeout(() => el.style.color = '', 300);
        }
    }

    // --- DB & REALTIME ---
    async function initSupabase() {
        try {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const viewerId = Math.random().toString(36).substring(2, 10);
            
            const { data } = await supabaseClient
                .from('video_stats')
                .select('share_count')
                .eq('id', 1)
                .single();
            if (data) updateShareUI(data.share_count);

            channel = supabaseClient.channel('svt_live_room_v1', {
                config: { presence: { key: viewerId } }
            });

            channel.on('presence', { event: 'sync' }, () => {
                const state = channel.presenceState();
                const count = Object.keys(state).length;
                const el = document.getElementById('liveCount');
                el.innerText = count.toLocaleString();
                el.style.color = '#22c55e';
                setTimeout(() => el.style.color = '', 300);
            });

            supabaseClient
                .channel('db_changes')
                .on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'video_stats', filter: 'id=eq.1' },
                    (payload) => {
                        if (payload.new && payload.new.share_count) {
                            updateShareUI(payload.new.share_count);
                        }
                    }
                )
                .subscribe();

            channel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({ online_at: new Date().toISOString() });
                }
            });

        } catch (err) { console.error(err); }
    }

    // --- PLAYER ---
    function initPlayer() {
        const video = document.getElementById('videoPlayer');
        const streamUrl = 'https://sgp1.angelthump.com/hls/MjAyNi0wMi0yMVQwOTo0NTowOS43Mzdabm90aGluZ3JvdW5k_nothinground/index.m3u8';
        if (Hls.isSupported()) {
            const hls = new Hls(); hls.loadSource(streamUrl); hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = streamUrl;
        }
        showControls();
    }

    const container = document.getElementById('videoContainer');
    const playBtn = document.getElementById('playBtn');
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const fsBtn = document.getElementById('fsBtn');
    const centerIcon = document.getElementById('centerIcon');
    const videoElem = document.getElementById('videoPlayer');
    const themeIcon = document.getElementById('themeIcon');
    let lastTap = 0, controlsTimeout;

    function showControls() { 
        container.classList.add('show-controls'); 
        clearTimeout(controlsTimeout); 
        controlsTimeout = setTimeout(() => { 
            if(!videoElem.paused) container.classList.remove('show-controls'); 
        }, 2000); 
    }

    container.onclick = e => {
        if(e.target.closest('.bottom-bar')) return;
        const now = Date.now();
        if (now - lastTap < 300) togglePlay();
        else container.classList.contains('show-controls') ? container.classList.remove('show-controls') : showControls();
        lastTap = now;
    };

    function togglePlay() {
        if (videoElem.paused) { videoElem.play(); playBtn.innerHTML = '<i class="fas fa-pause"></i>'; animateIcon('fa-play'); } 
        else { videoElem.pause(); playBtn.innerHTML = '<i class="fas fa-play"></i>'; animateIcon('fa-pause'); }
        showControls();
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('zoneTheme', isLight ? 'light' : 'dark');
        themeIcon.className = isLight ? 'fas fa-sun' : 'fas fa-moon';
    }

    playBtn.onclick = e => { e.stopPropagation(); togglePlay(); };
    muteBtn.onclick = e => {
        e.stopPropagation();
        videoElem.muted = !videoElem.muted;
        videoElem.volume = videoElem.muted ? 0 : 1;
        volumeSlider.value = videoElem.volume;
        muteBtn.innerHTML = videoElem.volume === 0 ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        showControls();
    };
    volumeSlider.oninput = e => {
        videoElem.volume = e.target.value;
        videoElem.muted = videoElem.volume === 0;
        muteBtn.innerHTML = videoElem.volume === 0 ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    };
    fsBtn.onclick = e => {
        e.stopPropagation();
        if (!document.fullscreenElement) {
            if (container.requestFullscreen) container.requestFullscreen();
            else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
            if (screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape').catch(() => {});
            fsBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            document.exitFullscreen();
            if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
            fsBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
    };
    function animateIcon(icon) {
        centerIcon.innerHTML = `<i class="fas ${icon}"></i>`;
        centerIcon.classList.remove('animate', 'fade-out');
        void centerIcon.offsetWidth;
        centerIcon.classList.add('animate');
        setTimeout(() => centerIcon.classList.add('fade-out'), 300);
    }
    
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && [73, 67, 74].includes(e.keyCode)) || (e.ctrlKey && e.keyCode == 85)) return false; };
</script>
</body>
</html>
